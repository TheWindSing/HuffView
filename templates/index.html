<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Huffman ç¼–ç å¯è§†åŒ–</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vis-network/standalone/umd/vis-network.min.js"></script>
  <style>
    :root {
      --primary: #0d6efd;
      --background: #f8f9fa;
      --text: #212529;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      color: var(--text);
      background: white;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: white;
      border-bottom: 1px solid #ddd;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.5rem;
    }
    .container {
      display: flex;
    }
    aside {
      width: 250px;
      background: var(--background);
      padding: 1rem;
      height: 100vh;
      overflow-y: auto;
      position: sticky;
      top: 72px;
      border-right: 1px solid #ddd;
    }
    aside h3 {
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    aside details summary {
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    aside a {
      display: block;
      margin-left: 1rem;
      color: var(--primary);
      text-decoration: none;
      margin-bottom: 0.3rem;
    }
    main {
      flex: 1;
      padding: 2rem;
    }
    textarea {
      width: 100%;
      padding: 0.75em;
      font-size: 1rem;
      margin-bottom: 1rem;
      resize: vertical;
    }
    .btn {
      display: inline-block;
      margin: 0.5em 1em 0.5em 0;
      padding: 0.5em 1.5em;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 1rem;
    }
    .btn:hover {
      background: #084298;
    }
    .section {
      margin-top: 3rem;
    }
    .section h2 {
      border-bottom: 2px solid var(--primary);
      padding-bottom: 0.25em;
    }
    .block-text {
      background: #f1f3f5;
      padding: 1em;
      border-radius: 6px;
      word-break: break-all;
      margin-top: 0.5em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
    }
    th, td {
      border: 1px solid #dee2e6;
      padding: 0.75em;
      text-align: center;
    }
    #treeContainer {
      margin-top: 1.5rem;
      width: 100%;
      height: 400px;
      border: 1px solid #ccc;
      background: #fff;
      border-radius: 4px;
    }

    #freqChart {
      width: 100%;
      max-height: 400px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Huffman ç¼–ç å¯è§†åŒ–å·¥å…·</h1>
  </header>
  <div class="container">
    <aside>
      <h3>å¯¼èˆª</h3>
      <details open>
        <summary>å†…å®¹è·³è½¬</summary>
        <a href="#input">è¾“å…¥ä¸æ“ä½œ</a>
        <a href="#original">åŸæ–‡</a>
        <a href="#encoded">ç¼–ç </a>
        <!-- <a href="#decoded">è¯‘ç ç»“æœ</a> -->
        <a href="#efficiency">ç¼–ç æ•ˆç‡</a> 
        <a href="#frequency">å­—ç¬¦é¢‘ç‡</a>
        <a href="#codeMap">ç¼–ç è¡¨</a>
        <a href="#chart">é¢‘ç‡å›¾è¡¨</a>
        <a href="#tree">Huffman æ ‘</a>
      </details>
            <details open>
        <summary>è¡¥å……</summary>
        <p style="margin: 0.5rem 0 0.5rem 1rem; font-size: 0.9rem; color: #555;">
          æœ¬å·¥å…·ç”¨äº Huffman ç¼–ç çš„æ¼”ç¤ºã€ç¼–ç ç»“æ„å¯è§†åŒ–ä¸å­—ç¬¦ç»Ÿè®¡åˆ†æã€‚
          ç‚¹å‡»ä¸Šé¢é¡¹ç›®è·³è½¬åˆ°å¯¹åº”åŒºåŸŸğŸ‘†
        </p>
        <div style="margin: 1rem 0 0 1rem; font-size: 0.92rem; color: #666;">
            ä½œè€…ï¼š
            <a href="https://thewindsing.blog/about/index.html" target="_blank" style="color: var(--primary); text-decoration: underline;">Zeng Wenxing</a><br>
          ä¸ªäººåšå®¢ï¼š<a href="https://thewindsing.blog" target="_blank" style="color: var(--primary); text-decoration: underline;">thewindsing.blog</a><br>
          é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/TheWindSing/HuffView" target="_blank" style="color: var(--primary); text-decoration: underline;">HuffView</a>
        </div>
      </details>
    </aside>
    <main>
      <section id="input">
        <h2>è¾“å…¥ä¸æ“ä½œ</h2>
        <textarea id="inputText" placeholder="è¯·è¾“å…¥è¦ç¼–ç æˆ–è¯‘ç çš„æ–‡æœ¬æˆ–01ä¸²...">huffman coding example</textarea>
        <br>
        <button class="btn" onclick="encodeText()">ç¼–ç </button>
        <button class="btn" onclick="decodeText()">è¯‘ç </button>
        <button class="btn" onclick="copyEncoded()">å¤åˆ¶ç¼–ç </button>
        <button class="btn" onclick="copyDecoded()">å¤åˆ¶è¯‘ç </button>
        <button class="btn" onclick="downloadEncoded()">ä¸‹è½½ç¼–ç ç»“æœ</button>
        <button class="btn" onclick="downloadDecoded()">ä¸‹è½½è¯‘ç ç»“æœ</button>
      </section>


      <section id="original" class="section">
        <h2>åŸæ–‡</h2>
        <div class="block-text" id="originalText"></div>
      </section>

      <section id="encoded" class="section">
        <h2>ç¼–ç </h2>
        <div class="block-text" id="encodedText"></div>
      </section>

      <!-- <section id="decoded" class="section">
        <h2>è¯‘ç ç»“æœ</h2>
        <div class="block-text" id="decodedText"></div>
      </section> -->

      <section id="efficiency" class="section">
        <h2>ç¼–ç æ•ˆç‡</h2>
        <table>
          <thead>
            <tr>
              <th>åŸå§‹æ¯”ç‰¹æ•°</th>
              <th>ç¼–ç åæ¯”ç‰¹æ•°</th>
              <th>å‹ç¼©ç‡ (%)</th>
              <th>ç†µ (H)</th>
              <th>å¹³å‡ç é•¿ (L)</th>
              <th>ç¼–ç æ•ˆç‡ (%)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td id="originalBits">-</td>
              <td id="encodedBits">-</td>
              <td id="compressionRate">-</td>
              <td id="entropy">-</td>
              <td id="avgLength">-</td>
              <td id="codingEfficiency">-</td>
            </tr>
          </tbody>
        </table>
      </section>

      <section id="frequency" class="section">
        <h2>å­—ç¬¦é¢‘ç‡</h2>
        <table>
          <thead><tr><th>å­—ç¬¦</th><th>é¢‘æ•°</th></tr></thead>
          <tbody id="freqTable"></tbody>
        </table>
      </section>

      <section id="codeMap" class="section">
        <h2>ç¼–ç è¡¨</h2>
        <table>
          <thead><tr><th>å­—ç¬¦</th><th>ç¼–ç </th></tr></thead>
          <tbody id="codeTable"></tbody>
        </table>
      </section>

      <section id="chart" class="section">
        <h2>å­—ç¬¦é¢‘ç‡å›¾è¡¨</h2>
        <canvas id="freqChart"></canvas>
      </section>

      <section id="tree" class="section">
        <h2>Huffman æ ‘ç»“æ„</h2>
        <div id="treeContainer"></div>
      </section>
    </main>
  </div>
  <script>
    let chartInstance;
    let treeData = {};

    async function encodeText() {
      const text = document.getElementById("inputText").value.trim();
      if (!text) return alert("è¯·è¾“å…¥æ–‡æœ¬");

      const res = await fetch("/huffman", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });

      const data = await res.json();

      if (data.error) return alert("é”™è¯¯: " + data.error);

      treeData = data.tree || {};

      document.getElementById("originalText").textContent = text;
      document.getElementById("encodedText").textContent = data.encoded;
      // document.getElementById("decodedText").textContent = data.decoded;

      // æ›´æ–°ç¼–ç æ•ˆç‡
      document.getElementById("originalBits").textContent = data.originalBits;
      document.getElementById("encodedBits").textContent = data.encodedBits;
      document.getElementById("compressionRate").textContent = data.compressionRate;
      document.getElementById("entropy").textContent = data.entropy;
      document.getElementById("avgLength").textContent = data.averageLength;
      document.getElementById("codingEfficiency").textContent = data.codingEfficiency + "%";

      const freqTable = document.getElementById("freqTable");
      const codeTable = document.getElementById("codeTable");
      freqTable.innerHTML = codeTable.innerHTML = "";

      const labels = [], values = [];

      Object.entries(data.frequency).forEach(([char, freq]) => {
        const name = char === ' ' ? '(ç©ºæ ¼)' : char;
        const row = document.createElement("tr");
        row.innerHTML = `<td>${name}</td><td>${freq}</td>`;
        freqTable.appendChild(row);
        labels.push(name);
        values.push(freq);
      });

      Object.entries(data.codeMap).forEach(([char, code]) => {
        const name = char === ' ' ? '(ç©ºæ ¼)' : char;
        const row = document.createElement("tr");
        row.innerHTML = `<td>${name}</td><td>${code}</td>`;
        codeTable.appendChild(row);
      });

      drawChart(labels, values);
      drawTree(treeData);
    }

    async function decodeText() {
      const encoded = document.getElementById("inputText").value.trim();
      if (!encoded) return alert("è¯·è¾“å…¥ç¼–ç ");

      if (!treeData || Object.keys(treeData).length === 0) {
        return alert("è¯·å…ˆè¿›è¡Œä¸€æ¬¡ç¼–ç æ“ä½œï¼Œä»¥ç”Ÿæˆ Huffman æ ‘ç»“æ„");
      }

      const res = await fetch("/decode", { 
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ encoded, tree: treeData })
      });

      const data = await res.json();

      if (data.error) {
          alert("è¯‘ç å¤±è´¥: " + data.error);
      } else {    
          document.getElementById("originalText").textContent = data.decoded; 
          document.getElementById("encodedText").textContent = document.getElementById("inputText").value; 
      }
    }

    function drawChart(labels, values) {
      const ctx = document.getElementById('freqChart').getContext('2d');
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'å­—ç¬¦é¢‘ç‡',
            data: values,
            backgroundColor: 'rgba(75, 192, 192, 0.6)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: {
            padding: 20
          },
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        }
      });
    }

    function drawTree(root) {
      if (!root || Object.keys(root).length === 0) return;
      let nodes = [], edges = [];
      let idCounter = 0;

      function traverse(node, parentId = null) {
        const thisId = idCounter++;
        const label = node.char !== null ? `${node.char} (${node.freq})` : `${node.freq}`;
        nodes.push({ id: thisId, label });
        if (parentId !== null) edges.push({ from: parentId, to: thisId });
        if (node.left) traverse(node.left, thisId);
        if (node.right) traverse(node.right, thisId);
      }

      traverse(root);
      const container = document.getElementById('treeContainer');
      const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
      const options = {
        layout: { hierarchical: { direction: 'UD', sortMethod: 'directed' } },
        physics: false
      };
      new vis.Network(container, data, options);
    }

    function copyEncoded() {
      const text = document.getElementById("encodedText").textContent;
      navigator.clipboard.writeText(text).then(() => alert("ç¼–ç ç»“æœå·²å¤åˆ¶ï¼"));
    }

    function downloadEncoded() {
      const text = document.getElementById("encodedText").textContent;
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'encoded.txt';
      a.click();
      URL.revokeObjectURL(url);
    }

    function copyDecoded() {
      const text = document.getElementById("originalText").textContent;
      if (!text) return alert("æ²¡æœ‰è¯‘ç ç»“æœå¯å¤åˆ¶");
      navigator.clipboard.writeText(text).then(() => alert("è¯‘ç ç»“æœå·²å¤åˆ¶ï¼"));
    }

    function downloadDecoded() {
      const text = document.getElementById("originalText").textContent;
      if (!text) return alert("æ²¡æœ‰è¯‘ç ç»“æœå¯ä¸‹è½½");
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'decoded.txt';
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
